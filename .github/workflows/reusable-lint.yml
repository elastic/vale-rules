name: Vale Lint (Reusable)

on:
  workflow_call:
    inputs:
      include_paths:
        description: 'Space-separated list of path prefixes to include (e.g., "docs/ packages/"). If empty, lints all changed .md/.adoc files.'
        required: false
        type: string
        default: ''
      fail_on_error:
        description: 'Fail the workflow if Vale finds error-level issues'
        required: false
        type: boolean
        default: false
      ref:
        description: 'Git ref to checkout. For pull_request_target, pass github.event.pull_request.head.sha'
        required: false
        type: string
        default: ''

permissions:
  contents: read

jobs:
  vale-lint:
    name: Lint Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # For pull_request_target, we need to checkout the PR head, not the base
          # The caller should pass github.event.pull_request.head.sha as ref
          ref: ${{ inputs.ref || github.sha }}
          fetch-depth: 0

      - name: Fetch base branch for diff
        if: github.event_name == 'pull_request' || github.event_name == 'pull_request_target'
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1

      - name: Install Vale
        run: |
          sudo snap install vale

      - name: Configure Vale with Elastic style guide
        run: |
          cat > .vale.ini << 'EOF'
          StylesPath = .vale-styles
          Packages = https://github.com/elastic/vale-rules/releases/latest/download/elastic-vale.zip
          EOF

          vale sync

      - name: Get changed files
        id: changed-files
        env:
          INCLUDE_PATHS: ${{ inputs.include_paths }}
        run: |
          # Get the base SHA for comparison
          if [ "${{ github.event_name }}" == "pull_request" ] || [ "${{ github.event_name }}" == "pull_request_target" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            # For push events, compare with parent commit
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi

          echo "Comparing $BASE_SHA...$HEAD_SHA"

          # Get all changed markdown/adoc files
          git diff --name-only --diff-filter=d "$BASE_SHA"..."$HEAD_SHA" \
            | grep -E '\.(md|adoc)$' > all_changed.txt || true

          if [ ! -s all_changed.txt ]; then
            echo "No markdown or adoc files changed"
            echo "has_files=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "All changed files:"
          cat all_changed.txt

          # Filter by include_paths if provided
          if [ -n "$INCLUDE_PATHS" ]; then
            echo "Filtering by include_paths: $INCLUDE_PATHS"
            > changed_files.txt
            for path in $INCLUDE_PATHS; do
              # Remove trailing slash for consistent matching
              path="${path%/}"
              grep -E "^${path}(/|$)" all_changed.txt >> changed_files.txt || true
            done
            # Remove duplicates
            sort -u changed_files.txt -o changed_files.txt
          else
            cp all_changed.txt changed_files.txt
          fi

          if [ -s changed_files.txt ]; then
            echo "Files to lint:"
            cat changed_files.txt
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "No files match the include_paths filter"
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Vale
        id: vale
        if: steps.changed-files.outputs.has_files == 'true'
        run: |
          echo "Running Vale on changed files..."

          # Run Vale and capture exit code
          set +e
          vale --output=line $(cat changed_files.txt | tr '\n' ' ') 2>&1 | tee vale_output.txt
          VALE_EXIT=${PIPESTATUS[0]}
          set -e

          # Count issues by severity
          ERRORS=$(grep -c '^.*:[0-9]*:[0-9]*:error:' vale_output.txt || echo "0")
          WARNINGS=$(grep -c '^.*:[0-9]*:[0-9]*:warning:' vale_output.txt || echo "0")
          SUGGESTIONS=$(grep -c '^.*:[0-9]*:[0-9]*:suggestion:' vale_output.txt || echo "0")

          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
          echo "suggestions=$SUGGESTIONS" >> $GITHUB_OUTPUT

          echo ""
          echo "Summary: $ERRORS errors, $WARNINGS warnings, $SUGGESTIONS suggestions"

          if [ "$ERRORS" -gt 0 ]; then
            echo "has_errors=true" >> $GITHUB_OUTPUT
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
          fi

      - name: Fail on errors
        if: inputs.fail_on_error && steps.vale.outputs.has_errors == 'true'
        run: |
          echo "::error::Vale found ${{ steps.vale.outputs.errors }} error-level issue(s)"
          exit 1
