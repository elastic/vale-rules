name: Test Lint Action

on:
  pull_request:
    branches: [main]

# Cancel in-progress runs for the same PR
concurrency:
  group: test-lint-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  test-lint:
    name: Test (${{ matrix.style_source }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - style_source: released
            use_local_styles: 'false'
          - style_source: local
            use_local_styles: 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run lint action
        id: lint
        uses: ./lint
        with:
          files: .github/test-fixtures/sample-violations.md
          fail_on_error: 'false'
          use_local_styles: ${{ matrix.use_local_styles }}
          disable_telemetry: 'true'
          upload_artifact: 'false'  # Skip internal upload, we handle it below
          debug: 'true'

      - name: Verify report was generated
        run: |
          if [ ! -f vale_report.md ]; then
            echo "::error::vale_report.md was not generated"
            exit 1
          fi
          echo "✓ vale_report.md exists"
          echo "Report contents:"
          cat vale_report.md

      - name: Verify issues were found
        run: |
          if [ ! -f issue_counts.txt ]; then
            echo "::error::issue_counts.txt was not generated"
            exit 1
          fi

          source issue_counts.txt
          total=$((errors + warnings + suggestions))

          echo "Found: $errors errors, $warnings warnings, $suggestions suggestions"

          # sample-violations.md should trigger multiple issues
          if [ "$total" -eq 0 ]; then
            echo "::error::Expected issues in sample-violations.md but found none"
            exit 1
          fi

          echo "✓ Issues detected as expected (total: $total)"

      - name: Verify specific rules are working
        run: |
          echo "Checking that key rules fired..."
          
          # These rules should all trigger on sample-violations.md
          rules_to_check=(
            "Elastic.Articles"
            "Elastic.BritishSpellings"
            "Elastic.WordChoice"
            "Elastic.OxfordComma"
            "Elastic.Wordiness"
            "Elastic.DontUse"
            "Elastic.Exclamation"
          )
          
          failed=0
          for rule in "${rules_to_check[@]}"; do
            if grep -q "$rule" vale_report.md; then
              echo "✓ $rule fired"
            else
              echo "::error::$rule did not fire - rule may be broken"
              failed=1
            fi
          done
          
          if [ "$failed" -eq 1 ]; then
            exit 1
          fi
          
          echo "✓ All key rules verified"

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-results-${{ matrix.style_source }}
          path: |
            vale_report.md
            issue_counts.txt
          retention-days: 5

  # Test that clean files produce no issues (no false positives)
  test-clean-file:
    name: Test clean file (no false positives)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run lint on clean file
        id: lint-clean
        uses: ./lint
        with:
          files: .github/test-fixtures/clean-doc.md
          fail_on_error: 'true'  # Should pass since file is clean
          use_local_styles: 'true'
          disable_telemetry: 'true'
          upload_artifact: 'false'
          debug: 'true'

      - name: Verify no issues found
        run: |
          if [ ! -f issue_counts.txt ]; then
            echo "::error::issue_counts.txt was not generated"
            exit 1
          fi

          source issue_counts.txt
          total=$((errors + warnings + suggestions))

          if [ "$total" -gt 0 ]; then
            echo "::error::Clean file should have 0 issues but found $total"
            echo "Report contents:"
            cat vale_report.md
            exit 1
          fi

          echo "✓ Clean file correctly produced no issues"

  # Test include_paths filtering
  test-include-paths:
    name: Test include_paths filtering
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run lint with include_paths filter
        id: lint-filtered
        uses: ./lint
        with:
          files: .github/test-fixtures/team-a/doc.md .github/test-fixtures/team-b/doc.md
          include_paths: .github/test-fixtures/team-a
          fail_on_error: 'false'
          use_local_styles: 'true'
          disable_telemetry: 'true'
          upload_artifact: 'false'
          debug: 'true'

      - name: Verify filtering worked
        run: |
          if [ ! -f vale_report.md ]; then
            echo "::error::vale_report.md was not generated"
            exit 1
          fi

          # Check that team-a is in the report but team-b is not
          if grep -q "team-a" vale_report.md; then
            echo "✓ team-a files were linted"
          else
            echo "::error::team-a files should have been linted"
            exit 1
          fi

          if grep -q "team-b" vale_report.md; then
            echo "::error::team-b files should have been filtered out"
            exit 1
          else
            echo "✓ team-b files were correctly filtered out"
          fi

  # This job runs after all matrix jobs complete to upload a single artifact
  # that the report action can download
  upload-results:
    name: Upload combined results
    runs-on: ubuntu-latest
    needs: [test-lint, test-clean-file, test-include-paths]
    if: always()

    steps:
      - name: Download local styles results
        uses: actions/download-artifact@v6
        with:
          name: test-results-local

      - name: Upload as vale-results for report action
        uses: actions/upload-artifact@v6
        with:
          name: vale-results
          path: |
            vale_report.md
            issue_counts.txt
          retention-days: 1
