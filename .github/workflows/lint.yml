name: Vale Lint with reviewdog

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  vale-lint:
    name: Vale Lint / macOS
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for proper diff
          
      - name: Install Homebrew and dependencies
        run: |
          if ! command -v brew &> /dev/null; then
            echo "Installing Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            # Add Homebrew to PATH for subsequent steps
            echo "/opt/homebrew/bin" >> $GITHUB_PATH
          else
            echo "Homebrew is already installed"
          fi
          
          # Install jq if not available (needed for JSON processing)
          if ! command -v jq &> /dev/null; then
            echo "Installing jq..."
            brew install jq
          fi
          
      - name: Run install script
        run: |
          chmod +x ./install-macos.sh
          ./install-macos.sh
          
      - name: Install reviewdog
        uses: reviewdog/action-setup@v1
        with:
          reviewdog_version: latest
          
      - name: Get changed files
        id: changed-files
        run: |
          # Get list of changed .md and .adoc files in this PR
          git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(md|adoc)$' > changed_files.txt || echo "No markdown/adoc files changed"
          
          if [ -s changed_files.txt ]; then
            echo "Found changed files:"
            cat changed_files.txt
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "No markdown or adoc files changed in this PR"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Run Vale on changed files
        if: steps.changed-files.outputs.has_changes == 'true'
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Run Vale on changed files and pipe to reviewdog
          if [ -s changed_files.txt ]; then
            echo "Running Vale on changed files..."
            
            # Run Vale with line-based output format for reviewdog
            cat changed_files.txt | xargs vale --output=line 2>&1 | \
            reviewdog -f=vale -name="vale" -reporter=github-pr-review -filter-mode=added
          else
            echo "No files to check"
          fi
          
      - name: Run Vale summary for PR comment
        if: steps.changed-files.outputs.has_changes == 'true'
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Also run in comment mode for a summary
          if [ -s changed_files.txt ]; then
            echo "Running Vale for PR comments..."
            
            cat changed_files.txt | xargs vale --output=line 2>&1 | \
            reviewdog -f=vale -name="vale-summary" -reporter=github-pr-comment
          fi